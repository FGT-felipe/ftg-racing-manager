rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny for writes, but logged-in users can read game data like universe, season, press.
    match /{document=**} {
      allow read: if request.auth != null; 
      allow write: if false; 
    }
    
    // Allow users to manage their own Manager profile
    match /managers/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow users to update the specific team they control.
    // At creation, they claim a team. To prevent taking another's team, 
    // the rule ensures the request matches their auth UID.
    match /teams/{teamId} {
      allow read: if request.auth != null;
      // You can write to a team if you are claiming it (managerId goes from null to your UID)
      // OR if you currently own it.
      allow write: if request.auth != null && 
        (resource.data.managerId == request.auth.uid || 
        (resource == null || !("managerId" in resource.data) || resource.data.managerId == null || resource.data.managerId == ''));
    }

    // Allow user record modifications
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Since users currently apply youth academy upgrades, driver signings, etc.
    // Ensure they can read/write their team's subcollections ONLY if they own the team.
    match /teams/{teamId}/{document=**} {
      // Allow read/write if the user is the owner of the parent team document
      allow read, write: if request.auth != null && (get(/databases/$(database)/documents/teams/$(teamId)).data.managerId == request.auth.uid);
    }
  }
}